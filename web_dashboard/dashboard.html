<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="EnviTrack">
    <title>EnviTrack - Environmental Monitoring</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="premium-dashboard.css">
    <link rel="stylesheet" href="enhanced-styles.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Authentication Check -->
    <script>
        // Check if user is logged in
        window.addEventListener('load', () => {
            const isLoggedIn = sessionStorage.getItem('ecomonitor_logged_in');
            const rememberMe = localStorage.getItem('ecomonitor_remember');
            
            if (isLoggedIn !== 'true' && rememberMe !== 'true') {
                // Not logged in, redirect to login page
                window.location.href = 'login.html';
            }
        });
        
        // Logout function - shows modal
        function logout() {
            document.getElementById('logoutModal').classList.add('active');
        }

        // Close logout modal
        function closeLogoutModal() {
            document.getElementById('logoutModal').classList.remove('active');
        }

        // Confirm logout
        function confirmLogout() {
            sessionStorage.removeItem('ecomonitor_logged_in');
            sessionStorage.removeItem('ecomonitor_user');
            localStorage.removeItem('ecomonitor_remember');
            localStorage.removeItem('ecomonitor_user');
            window.location.href = 'login.html';
        }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafb;
            color: #1e293b;
            overflow: hidden;
            height: 100vh;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100vh;
            gap: 0;
        }

        /* Left Sidebar - Logo & Info */
        .sidebar-left {
            background: white;
            border-right: 1px solid #e2e8f0;
            padding: 30px 24px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
        }

        .logo-section {
            margin-bottom: 40px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
        }

        .logo-subtitle {
            font-size: 13px;
            color: #64748b;
            margin-left: 60px;
        }

        .status-section {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-size: 14px;
            font-weight: 600;
            color: #065f46;
        }

        .status-time {
            font-size: 12px;
            color: #059669;
        }

        .info-grid {
            display: grid;
            gap: 16px;
        }

        .info-item {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border-radius: 12px;
            padding: 18px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .info-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #cbd5e1;
        }

        .info-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Sidebar Logout Button */
        .sidebar-logout {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .sidebar-logout-btn {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            color: #64748b;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .sidebar-logout-btn:hover {
            background: #fef2f2;
            border-color: #fca5a5;
            color: #dc2626;
            transform: translateX(2px);
        }

        .sidebar-logout-btn:active {
            transform: translateX(0);
        }

        .logout-icon {
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .sidebar-logout-btn:hover .logout-icon {
            transform: translateX(2px);
        }

        .logout-text {
            font-size: 13px;
        }

        /* Main Content */
        .main-content {
            padding: 30px;
            overflow-y: auto;
            background: #f8fafb;
        }

        .header {
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 6px;
        }

        .header p {
            font-size: 14px;
            color: #64748b;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 28px;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .metric-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.05) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .metric-card:hover::before {
            opacity: 1;
        }

        .metric-card:hover::after {
            opacity: 1;
        }

        .metric-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            border-color: #cbd5e1;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .metric-label {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }

        .metric-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            position: relative;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .metric-card:hover .metric-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .icon-temp { 
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.4);
        }
        .icon-humidity { 
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        }
        .icon-air { 
            background: linear-gradient(135deg, #34d399, #10b981);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
        }

        .metric-value {
            font-size: 52px;
            font-weight: 800;
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
            transition: transform 0.3s ease;
        }

        .metric-card:hover .metric-value {
            transform: scale(1.05);
        }

        .metric-unit {
            font-size: 22px;
            color: #94a3b8;
            font-weight: 600;
        }

        .metric-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .metric-status.good {
            background: #d1fae5;
            color: #065f46;
        }

        .metric-status.good::before {
            content: '‚óè';
            color: #10b981;
        }

        .metric-status.warning {
            background: #fef3c7;
            color: #92400e;
            animation: pulseWarning 2s ease-in-out infinite;
        }

        .metric-status.warning::before {
            content: '‚óè';
            color: #f59e0b;
        }

        .metric-status.critical {
            background: #fee2e2;
            color: #991b1b;
            animation: pulseCritical 1s ease-in-out infinite;
        }

        .metric-status.critical::before {
            content: '‚óè';
            color: #ef4444;
        }

        @keyframes pulseWarning {
            0%, 100% {
                background: #fef3c7;
                transform: scale(1);
            }
            50% {
                background: #fde68a;
                transform: scale(1.05);
            }
        }

        @keyframes pulseCritical {
            0%, 100% {
                background: #fee2e2;
                transform: scale(1);
            }
            50% {
                background: #fecaca;
                transform: scale(1.05);
            }
        }

        /* Heartbeat animation for warning/critical cards */
        .metric-card.warning {
            animation: heartbeatWarning 2s ease-in-out infinite;
            border: 2px solid #f59e0b !important;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }

        .metric-card.critical {
            animation: heartbeatCritical 1s ease-in-out infinite;
            border: 2px solid #ef4444 !important;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
        }

        @keyframes heartbeatWarning {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
            }
            10% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
            }
            20% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
            }
            30% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
            }
            40%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
            }
        }

        @keyframes heartbeatCritical {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
            }
            10% {
                transform: scale(1.08);
                box-shadow: 0 0 40px rgba(239, 68, 68, 0.7);
            }
            20% {
                transform: scale(1);
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
            }
            30% {
                transform: scale(1.08);
                box-shadow: 0 0 40px rgba(239, 68, 68, 0.7);
            }
            40%, 100% {
                transform: scale(1);
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
            }
        }

        .metric-status-text {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .chart-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 32px;
            border: 1px solid #e2e8f0;
            height: calc(100vh - 400px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .chart-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #f59e0b, #3b82f6, #10b981);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #0f172a;
        }

        .chart-subtitle {
            font-size: 13px;
            color: #64748b;
        }

        .chart-container {
            height: calc(100% - 60px);
        }



        /* Alert Popup Notifications */
        .alert-popup-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
            pointer-events: none;
        }

        .alert-popup {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border-left: 5px solid #ef4444;
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: all;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .alert-popup::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%);
            pointer-events: none;
        }

        .alert-popup.warning {
            border-left-color: #f59e0b;
        }

        .alert-popup.warning::before {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, transparent 100%);
        }

        .alert-popup.critical {
            border-left-color: #dc2626;
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1), shake 0.5s ease 0.4s;
        }

        .alert-popup.critical::before {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.08) 0%, transparent 100%);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(450px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(450px);
                opacity: 0;
            }
        }

        .alert-popup.closing {
            animation: slideOutRight 0.3s ease forwards;
        }

        .alert-popup:hover {
            transform: translateX(-8px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.25);
        }

        .alert-popup-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .alert-popup-icon {
            font-size: 32px;
            flex-shrink: 0;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .alert-popup-content {
            flex: 1;
        }

        .alert-popup-title {
            font-size: 16px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 6px;
        }

        .alert-popup-desc {
            font-size: 13px;
            color: #64748b;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .alert-popup-time {
            font-size: 11px;
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .alert-popup-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #64748b;
            transition: all 0.2s;
            opacity: 0;
        }

        .alert-popup:hover .alert-popup-close {
            opacity: 1;
        }

        .alert-popup-close:hover {
            background: #e2e8f0;
            color: #0f172a;
            transform: scale(1.1);
        }

        .alert-popup-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #ef4444, #dc2626);
            animation: progressBar 5s linear forwards;
        }

        .alert-popup.warning .alert-popup-progress {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        @keyframes progressBar {
            from { width: 100%; }
            to { width: 0%; }
        }



        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            padding: 24px;
        }

        .modal-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .modal-icon {
            font-size: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #0f172a;
        }

        .modal-time {
            font-size: 12px;
            color: #64748b;
        }

        .modal-body {
            padding: 24px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .anomaly-box {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .anomaly-metric {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .anomaly-icon {
            font-size: 32px;
        }

        .anomaly-label {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .anomaly-value {
            font-size: 24px;
            font-weight: 700;
            color: #ef4444;
        }

        .anomaly-threshold {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .ai-section {
            margin-top: 20px;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: #0891b2;
            font-weight: 600;
            font-size: 14px;
        }

        .ai-explanation {
            background: #f0f9ff;
            border-left: 3px solid #0891b2;
            padding: 16px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.7;
            color: #334155;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-primary {
            background: #0891b2;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: #0e7490;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .modal-logout {
            max-width: 420px;
        }

        .modal-header-logout {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
        }

        .modal-header-logout .modal-icon {
            font-size: 28px;
        }

        .modal-header-logout .modal-title {
            color: #991b1b;
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .dashboard {
                grid-template-columns: 240px 1fr;
            }
        }

        /* Mobile responsive for popups */
        @media (max-width: 768px) {
            .alert-popup-container {
                top: 80px;
                right: 16px;
                left: 16px;
                max-width: none;
            }

            .alert-popup {
                padding: 16px;
            }

            .alert-popup-icon {
                font-size: 28px;
            }

            .alert-popup-title {
                font-size: 15px;
            }

            .alert-popup-desc {
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .alert-popup-container {
                top: 70px;
                right: 12px;
                left: 12px;
            }

            .alert-popup {
                padding: 14px;
            }

            .alert-popup-header {
                gap: 10px;
            }

            .alert-popup-icon {
                font-size: 24px;
            }

            .alert-popup-title {
                font-size: 14px;
            }

            .alert-popup-desc {
                font-size: 11px;
            }
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: auto;
                min-height: 100vh;
            }

            .sidebar-left {
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
                padding: 20px;
            }

            .logo-section {
                margin-bottom: 20px;
            }

            .info-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }



            .main-content {
                padding: 20px;
                overflow-y: visible;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .chart-section {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            body {
                overflow-y: auto;
            }

            .dashboard {
                display: flex;
                flex-direction: column;
            }

            .sidebar-left {
                padding: 16px;
            }

            .logo {
                gap: 10px;
            }

            .logo-icon {
                width: 40px;
                height: 40px;
                font-size: 24px;
            }

            .logo-text {
                font-size: 20px;
            }

            .logo-subtitle {
                font-size: 11px;
                margin-left: 50px;
            }

            .info-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .info-item {
                padding: 12px;
            }

            .info-label {
                font-size: 10px;
            }

            .info-value {
                font-size: 18px;
            }

            .main-content {
                padding: 16px;
            }

            .header h1 {
                font-size: 22px;
            }

            .header p {
                font-size: 13px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 14px;
                margin-bottom: 20px;
            }

            .metric-card {
                padding: 20px;
            }

            .metric-icon {
                width: 48px;
                height: 48px;
                font-size: 24px;
            }

            .metric-value {
                font-size: 42px;
            }

            .metric-unit {
                font-size: 18px;
            }

            .chart-section {
                height: 350px;
                padding: 20px;
                margin-bottom: 20px;
            }

            .chart-title {
                font-size: 16px;
            }

            .chart-subtitle {
                font-size: 12px;
            }



            .alerts-title {
                font-size: 16px;
            }

            .alert-item {
                padding: 14px;
            }

            .alert-title {
                font-size: 13px;
            }

            .alert-desc {
                font-size: 11px;
            }

            .modal {
                width: 95%;
                max-height: 90vh;
            }

            .modal-header {
                padding: 20px;
            }

            .modal-title {
                font-size: 18px;
            }

            .modal-body {
                padding: 20px;
            }

            .anomaly-box {
                padding: 16px;
            }

            .anomaly-value {
                font-size: 20px;
            }

            .ai-explanation {
                font-size: 12px;
                padding: 14px;
            }
        }

        @media (max-width: 480px) {
            .sidebar-left {
                padding: 12px;
            }

            .status-section {
                padding: 14px;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .info-item {
                padding: 14px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .info-label {
                font-size: 11px;
                margin-bottom: 0;
            }

            .info-value {
                font-size: 20px;
            }

            .main-content {
                padding: 12px;
            }

            .header {
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 12px;
            }

            .metrics-grid {
                gap: 12px;
            }

            .metric-card {
                padding: 18px;
            }

            .metric-header {
                margin-bottom: 12px;
            }

            .metric-label {
                font-size: 12px;
            }

            .metric-icon {
                width: 44px;
                height: 44px;
                font-size: 22px;
            }

            .metric-value {
                font-size: 38px;
                margin-bottom: 10px;
            }

            .metric-unit {
                font-size: 16px;
            }

            .metric-status {
                font-size: 11px;
                padding: 5px 10px;
            }

            .chart-section {
                height: 300px;
                padding: 16px;
            }

            .chart-header {
                margin-bottom: 16px;
            }

            .chart-title {
                font-size: 15px;
            }

            .chart-subtitle {
                font-size: 11px;
            }





            .modal {
                width: 96%;
                border-radius: 16px;
            }

            .modal-header {
                padding: 16px;
            }

            .modal-title-row {
                gap: 10px;
            }

            .modal-icon {
                font-size: 20px;
            }

            .modal-title {
                font-size: 16px;
            }

            .modal-time {
                font-size: 11px;
            }

            .modal-body {
                padding: 16px;
            }

            .anomaly-box {
                padding: 14px;
            }

            .anomaly-metric {
                gap: 12px;
            }

            .anomaly-icon {
                font-size: 28px;
            }

            .anomaly-label {
                font-size: 12px;
            }

            .anomaly-value {
                font-size: 18px;
            }

            .anomaly-threshold {
                font-size: 11px;
            }

            .ai-header {
                font-size: 13px;
                margin-bottom: 10px;
            }

            .ai-explanation {
                font-size: 11px;
                padding: 12px;
                line-height: 1.6;
            }

            .modal-footer {
                padding: 12px 16px;
                flex-direction: column;
            }

            .btn {
                width: 100%;
                padding: 12px;
                justify-content: center;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .metric-card,
            .alert-item,
            .info-item,
            .btn {
                -webkit-tap-highlight-color: transparent;
            }

            .metric-card:active {
                transform: scale(0.98);
            }

            .alert-item:active {
                transform: translateX(6px) scale(0.98);
            }

            .btn:active {
                transform: scale(0.95);
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Left Sidebar -->
        <aside class="sidebar-left">
            <div class="logo-section">
                <div class="logo">
                    <div class="logo-icon">üåç</div>
                    <div class="logo-text">EcoMonitor</div>
                </div>
                <div class="logo-subtitle">Environmental Monitoring Dashboard</div>
            </div>

            <div class="status-section" id="connectionStatus">
                <div class="status-row">
                    <div class="status-dot" id="statusDot"></div>
                    <div class="status-text" id="statusText">Connecting...</div>
                </div>
                <div class="status-time" id="updateTime">Waiting for data...</div>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Data Points</div>
                    <div class="info-value" id="dataPoints">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Avg Temperature</div>
                    <div class="info-value" id="avgTemp">--¬∞C</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Avg Humidity</div>
                    <div class="info-value" id="avgHumidity">--%</div>
                </div>
            </div>

            <!-- Logout Button in Sidebar -->
            <div class="sidebar-logout">
                <button onclick="logout()" class="sidebar-logout-btn">
                    <span class="logout-icon">‚Üí</span>
                    <span class="logout-text">Sign Out</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1>Environmental Monitoring</h1>
                <p>Real-time data collection and analysis for ecosystem health assessment</p>
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div>
                            <div class="metric-label">Temperature</div>
                        </div>
                        <div class="metric-icon icon-temp">üå°Ô∏è</div>
                    </div>
                    <div class="metric-value">
                        <span id="tempValue">--</span>
                        <span class="metric-unit">¬∞C</span>
                    </div>
                    <div class="metric-status good" id="tempStatus">
                        <span>Within normal range</span>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div>
                            <div class="metric-label">Humidity</div>
                        </div>
                        <div class="metric-icon icon-humidity">üíß</div>
                    </div>
                    <div class="metric-value">
                        <span id="humidityValue">--</span>
                        <span class="metric-unit">%</span>
                    </div>
                    <div class="metric-status good" id="humidityStatus">
                        <span>Within normal range</span>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div>
                            <div class="metric-label">Air Quality</div>
                        </div>
                        <div class="metric-icon icon-air">üå¨Ô∏è</div>
                    </div>
                    <div class="metric-value">
                        <span id="airValue">--</span>
                        <span class="metric-unit">ppm</span>
                    </div>
                    <div class="metric-status good" id="airStatus">
                        <span>Within normal range</span>
                    </div>
                </div>
            </div>

            <div class="chart-section">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">24-Hour Trends</div>
                        <div class="chart-subtitle">Environmental data over time</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </main>

    </div>

    <!-- Alert Popup Container -->
    <div class="alert-popup-container" id="alertPopupContainer"></div>

    <!-- Top Action Bar -->
    <div class="top-action-bar">
        <!-- Export Buttons -->
        <div class="export-buttons">
            <button onclick="exportToCSV()" class="btn-export" title="Export to CSV">
                üì• CSV
            </button>
            <button onclick="exportToPDF()" class="btn-export" title="Generate PDF Report">
                üìÑ PDF
            </button>
        </div>

        <!-- Settings Button -->
        <button onclick="openSettings()" class="settings-button" title="Settings">
            ‚öôÔ∏è
        </button>

        <!-- Dark Mode Toggle -->
        <button onclick="toggleDarkMode()" class="dark-mode-toggle" title="Toggle Dark Mode">
            <span id="darkModeIcon">üåô</span>
        </button>
    </div>

    <script>
        // Display logged-in user email
        window.addEventListener('load', () => {
            const userEmail = sessionStorage.getItem('ecomonitor_user') || localStorage.getItem('ecomonitor_user');
            if (userEmail) {
                document.getElementById('userEmail').textContent = userEmail.split('@')[0];
            }
        });
    </script>

    <!-- Settings Panel -->
    <div class="settings-overlay" id="settingsOverlay" onclick="closeSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h3>‚öôÔ∏è Settings</h3>
            <button onclick="closeSettings()">‚úï</button>
        </div>
        
        <div class="settings-section">
            <h4>üå°Ô∏è Temperature Thresholds</h4>
            <label>
                Minimum Temperature (¬∞C)
                <input type="number" id="tempMin" value="15" step="0.5">
            </label>
            <label>
                Maximum Temperature (¬∞C)
                <input type="number" id="tempMax" value="35" step="0.5">
            </label>
        </div>
        
        <div class="settings-section">
            <h4>üíß Humidity Thresholds</h4>
            <label>
                Minimum Humidity (%)
                <input type="number" id="humidityMin" value="30" step="1">
            </label>
            <label>
                Maximum Humidity (%)
                <input type="number" id="humidityMax" value="80" step="1">
            </label>
        </div>
        
        <div class="settings-section">
            <h4>üå¨Ô∏è Air Quality Threshold</h4>
            <label>
                Maximum Air Quality (ppm)
                <input type="number" id="airMax" value="600" step="10">
            </label>
        </div>
        
        <div class="settings-section">
            <h4>üîä Alert Sound</h4>
            <label>
                Select Alert Sound
                <select id="alertSound">
                    <option value="default">Default Beep</option>
                    <option value="chime">Chime</option>
                    <option value="bell">Bell</option>
                    <option value="siren">Siren (Urgent)</option>
                </select>
            </label>
            <button onclick="testAlertSound()" class="btn-test">üîä Test Sound</button>
        </div>
        
        <div class="settings-section">
            <h4>üíì Heartbeat Sound</h4>
            <label>
                <input type="checkbox" id="heartbeatSound" checked>
                Enable heartbeat sound with visual animations
            </label>
            <button onclick="testHeartbeatSound()" class="btn-test">üíì Test Heartbeat</button>
        </div>
        
        <div class="settings-section">
            <h4>üîä Background Alert Sound</h4>
            <label>
                <input type="checkbox" id="backgroundAlertSound" checked>
                Play selected alert sound continuously when thresholds are exceeded
            </label>
            <p style="font-size: 12px; color: #64748b; margin-top: 8px;">
                When enabled, your chosen alert sound will play repeatedly in the background while any metric exceeds its threshold.
            </p>
        </div>
        
        <div class="settings-actions">
            <button onclick="saveSettings()" class="btn-primary">üíæ Save Settings</button>
            <button onclick="resetSettings()" class="btn-secondary">üîÑ Reset to Defaults</button>
        </div>
    </div>

    <!-- Anomaly Modal -->
    <div class="modal-overlay" id="anomalyModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title-row">
                    <span class="modal-icon">‚ö†Ô∏è</span>
                    <span class="modal-title">Anomaly Detected</span>
                </div>
                <div class="modal-time" id="modalTime">11/28/2025, 9:56:48 PM</div>
            </div>
            <div class="modal-body">
                <div class="anomaly-box">
                    <div class="anomaly-metric">
                        <span class="anomaly-icon" id="modalIcon">üå°Ô∏è</span>
                        <div>
                            <div class="anomaly-label" id="modalMetric">Temperature</div>
                            <div class="anomaly-value" id="modalValue">32.5¬∞C</div>
                            <div class="anomaly-threshold" id="modalThreshold">(Threshold: 30¬∞C)</div>
                        </div>
                    </div>
                </div>

                <div class="ai-section">
                    <div class="ai-header">
                        <span>ü§ñ</span>
                        <span>AI-Powered Explanation</span>
                    </div>
                    <div class="ai-explanation" id="aiExplanation">
                        Click "Explain with AI" to generate an analysis of this anomaly.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" onclick="generateAI()">
                    <span>ü§ñ</span>
                    <span>Explain with AI</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="modal-overlay" id="logoutModal">
        <div class="modal modal-logout">
            <div class="modal-header modal-header-logout">
                <div class="modal-title-row">
                    <span class="modal-icon">üëã</span>
                    <span class="modal-title">Sign Out</span>
                </div>
            </div>
            <div class="modal-body">
                <p style="font-size: 15px; color: #475569; line-height: 1.6; text-align: center; padding: 20px 0;">
                    Are you sure you want to sign out of your EcoMonitor session?
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLogoutModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmLogout()">
                    <span>‚Üí</span>
                    <span>Sign Out</span>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBaWPavo-Gl005gMoy6E718KHI7WkZ-F7Y",
            authDomain: "ecomonitor-e79ca.firebaseapp.com",
            databaseURL: "https://ecomonitor-e79ca-default-rtdb.firebaseio.com",
            projectId: "ecomonitor-e79ca",
            storageBucket: "ecomonitor-e79ca.firebasestorage.app",
            messagingSenderId: "202779264082",
            appId: "1:202779264082:web:fb72e74d644c2a363f4b8b",
            measurementId: "G-CXENRXDGQR"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Debug: Test Firebase connection
        console.log('üöÄ EcoMonitor Dashboard Starting...');
        console.log('üî• Firebase App initialized');
        console.log('üåê Database URL:', firebaseConfig.databaseURL);
        
        // Test direct URL access
        console.log('üîç Test Firebase access:');
        console.log('   Open this URL in browser:', firebaseConfig.databaseURL + '/sensor_data.json');
        console.log('   Should show your data or null');
        let mainChart = null;
        let alertsHistory = [];
        let currentAnomaly = null;

        function createGradient(ctx, color1, color2) {
            const canvas = ctx.canvas;
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, color1 + '60');
            gradient.addColorStop(1, color2 + '10');
            return gradient;
        }

        function createChart(data, labels) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (mainChart) mainChart.destroy();
            
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Temperature (¬∞C)',
                            data: data.temp,
                            borderColor: '#f59e0b',
                            backgroundColor: createGradient(ctx, '#fbbf24', '#f59e0b'),
                            tension: 0.4,
                            borderWidth: 3,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#f59e0b',
                            pointHoverBorderWidth: 3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Humidity (%)',
                            data: data.humidity,
                            borderColor: '#3b82f6',
                            backgroundColor: createGradient(ctx, '#60a5fa', '#3b82f6'),
                            tension: 0.4,
                            borderWidth: 3,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#3b82f6',
                            pointHoverBorderWidth: 3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Air Quality (ppm)',
                            data: data.air,
                            borderColor: '#10b981',
                            backgroundColor: createGradient(ctx, '#34d399', '#10b981'),
                            tension: 0.4,
                            borderWidth: 3,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#10b981',
                            pointHoverBorderWidth: 3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top',
                            labels: { 
                                padding: 20,
                                font: { size: 13, weight: '600' },
                                color: '#475569',
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 8,
                                boxHeight: 8
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 },
                            displayColors: true,
                            boxWidth: 12,
                            boxHeight: 12,
                            boxPadding: 6
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { 
                                color: '#f1f5f9',
                                drawBorder: false
                            },
                            ticks: {
                                font: { size: 12, weight: '600' },
                                color: '#64748b',
                                padding: 10
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: {
                                font: { size: 12, weight: '600' },
                                color: '#64748b',
                                padding: 10
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                font: { size: 11 },
                                color: '#94a3b8',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 12
                            }
                        }
                    }
                }
            });
        }

        function updateMetrics(latest) {
            document.getElementById('tempValue').textContent = latest.temperature.toFixed(1);
            document.getElementById('humidityValue').textContent = latest.humidity.toFixed(1);
            document.getElementById('airValue').textContent = Math.round(latest.air_quality);

            // Use dynamic thresholds from settings
            const currentThresholds = window.thresholds || {
                tempMin: 15, tempMax: 35, humidityMin: 30, humidityMax: 80, airMax: 600
            };

            const tempStatus = (latest.temperature < currentThresholds.tempMin || latest.temperature > currentThresholds.tempMax) ? 'critical' : 'good';
            const humidityStatus = (latest.humidity < currentThresholds.humidityMin || latest.humidity > currentThresholds.humidityMax) ? 'warning' : 'good';
            const airStatus = latest.air_quality > currentThresholds.airMax ? 'critical' : 'good';

            updateStatus('tempStatus', tempStatus);
            updateStatus('humidityStatus', humidityStatus);
            updateStatus('airStatus', airStatus);

            // Add/remove heartbeat animation classes on metric cards
            updateCardAnimation('temp', tempStatus);
            updateCardAnimation('humidity', humidityStatus);
            updateCardAnimation('air', airStatus);

            // Start/stop background alert sounds based on threshold violations
            if (typeof startBackgroundAlertSound === 'function') {
                // Temperature
                if (tempStatus !== 'good') {
                    startBackgroundAlertSound('temperature');
                } else {
                    stopBackgroundAlertSound('temperature');
                }
                
                // Humidity
                if (humidityStatus !== 'good') {
                    startBackgroundAlertSound('humidity');
                } else {
                    stopBackgroundAlertSound('humidity');
                }
                
                // Air Quality
                if (airStatus !== 'good') {
                    startBackgroundAlertSound('airQuality');
                } else {
                    stopBackgroundAlertSound('airQuality');
                }
            }

            // Check for anomalies - will show popup every time value changes
            if (tempStatus !== 'good') {
                addAlert('Temperature Anomaly', 
                    latest.temperature > currentThresholds.tempMax ? 'High temperature detected' : 'Low temperature detected',
                    { metric: 'Temperature', value: latest.temperature.toFixed(1), unit: '¬∞C', 
                      threshold: latest.temperature > currentThresholds.tempMax ? `${currentThresholds.tempMax}¬∞C` : `${currentThresholds.tempMin}¬∞C`, icon: 'üå°Ô∏è' });
            } else {
                // Clear last value when back to normal
                delete lastAlertValues['Temperature Anomaly_Temperature'];
            }
            
            if (humidityStatus !== 'good') {
                addAlert('Humidity Anomaly',
                    latest.humidity > currentThresholds.humidityMax ? 'High humidity levels' : 'Low humidity levels',
                    { metric: 'Humidity', value: latest.humidity.toFixed(1), unit: '%',
                      threshold: latest.humidity > currentThresholds.humidityMax ? `${currentThresholds.humidityMax}%` : `${currentThresholds.humidityMin}%`, icon: 'üíß' });
            } else {
                delete lastAlertValues['Humidity Anomaly_Humidity'];
            }
            
            if (airStatus !== 'good') {
                addAlert('Air Quality Anomaly', 'Poor air quality detected',
                    { metric: 'Air Quality', value: Math.round(latest.air_quality), unit: ' ppm',
                      threshold: `${currentThresholds.airMax} ppm`, icon: 'üå¨Ô∏è' });
            } else {
                delete lastAlertValues['Air Quality Anomaly_Air Quality'];
            }
        }

        function updateStatus(id, status) {
            const el = document.getElementById(id);
            el.className = 'metric-status ' + status;
            el.innerHTML = status === 'good' ? '<span>Within normal range</span>' : 
                          status === 'warning' ? '<span>Warning level</span>' : '<span>Critical level</span>';
        }

        function updateCardAnimation(cardId, status) {
            // Find the metric card by looking for the one containing the value element
            const valueEl = document.getElementById(cardId + 'Value');
            if (!valueEl) return;
            
            const card = valueEl.closest('.metric-card');
            if (!card) return;
            
            // Remove all status classes
            card.classList.remove('warning', 'critical', 'good');
            
            // Add current status class and manage heartbeat sounds
            if (status === 'warning') {
                card.classList.add('warning');
                // Start warning heartbeat sound
                if (typeof startHeartbeatSound === 'function') {
                    startHeartbeatSound(cardId, 'warning');
                }
            } else if (status === 'critical') {
                card.classList.add('critical');
                // Start critical heartbeat sound
                if (typeof startHeartbeatSound === 'function') {
                    startHeartbeatSound(cardId, 'critical');
                }
            } else {
                card.classList.add('good');
                // Stop heartbeat sound when back to normal
                if (typeof stopHeartbeatSound === 'function') {
                    stopHeartbeatSound(cardId);
                }
            }
        }

        // Sound generation functions - REMOVED
        // Now using playCustomAlertSound() from features.js
        // This ensures all alert sounds use the customizable sound system

        function showAlertPopup(title, desc, data, severity = 'warning') {
            const container = document.getElementById('alertPopupContainer');
            const popup = document.createElement('div');
            popup.className = `alert-popup ${severity}`;
            
            const icon = data.icon || '‚ö†Ô∏è';
            
            popup.innerHTML = `
                <div class="alert-popup-header">
                    <div class="alert-popup-icon">${icon}</div>
                    <div class="alert-popup-content">
                        <div class="alert-popup-title">${title}</div>
                        <div class="alert-popup-desc">${desc}</div>
                        <div class="alert-popup-time">
                            <span>üïê</span>
                            <span>Just now</span>
                        </div>
                    </div>
                </div>
                <button class="alert-popup-close" onclick="closePopup(this)">‚úï</button>
                <div class="alert-popup-progress"></div>
            `;
            
            popup.onclick = function() {
                const index = alertsHistory.findIndex(a => a.title === title);
                if (index !== -1) showModal(index);
            };
            
            container.appendChild(popup);
            
            // Play sound (uses custom sound from settings in features.js)
            if (typeof playCustomAlertSound === 'function') {
                playCustomAlertSound();
            } else {
                console.warn('playCustomAlertSound not available - features.js not loaded?');
            }
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (popup.parentElement) {
                    popup.classList.add('closing');
                    setTimeout(() => popup.remove(), 300);
                }
            }, 5000);
            
            // Limit to 3 popups at once
            const popups = container.querySelectorAll('.alert-popup');
            if (popups.length > 3) {
                popups[0].classList.add('closing');
                setTimeout(() => popups[0].remove(), 300);
            }
        }

        window.closePopup = function(btn) {
            const popup = btn.closest('.alert-popup');
            popup.classList.add('closing');
            setTimeout(() => popup.remove(), 300);
        };

        let lastAlertValues = {};

        function addAlert(title, desc, data) {
            // Create unique key for this alert type
            const alertKey = `${title}_${data.metric}`;
            const currentValue = parseFloat(data.value);
            
            // Check if value has changed significantly (more than 0.5 units)
            const lastValue = lastAlertValues[alertKey];
            const hasChanged = !lastValue || Math.abs(currentValue - lastValue) > 0.5;
            
            // Always show popup if value changed or it's a new alert
            if (hasChanged) {
                lastAlertValues[alertKey] = currentValue;
                
                const alert = { title, desc, data, time: new Date() };
                alertsHistory.unshift(alert);
                if (alertsHistory.length > 50) alertsHistory.pop();
                
                // Determine severity
                let severity = 'warning';
                if (title.includes('Temperature') && (data.value > 35 || data.value < 10)) {
                    severity = 'critical';
                } else if (title.includes('Air Quality') && data.value > 800) {
                    severity = 'critical';
                }
                
                // Show popup notification with sound
                showAlertPopup(title, desc, data, severity);
            }
        }

        function renderAlerts() {
            const container = document.getElementById('alertsList');
            if (alertsHistory.length === 0) {
                container.innerHTML = `
                    <div class="alerts-empty">
                        <div class="empty-icon">‚úì</div>
                        <div class="empty-title">No Active Alerts</div>
                        <div class="empty-text">All environmental readings are within normal ranges</div>
                    </div>
                `;
            } else {
                container.innerHTML = alertsHistory.map((a, i) => `
                    <div class="alert-item" onclick="showModal(${i})">
                        <div class="alert-title">${a.title}</div>
                        <div class="alert-desc">${a.desc}</div>
                        <div class="alert-time">${getTimeAgo(a.time)}</div>
                    </div>
                `).join('');
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'less than a minute ago';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            return Math.floor(seconds / 3600) + ' hours ago';
        }

        window.showModal = function(index) {
            const alert = alertsHistory[index];
            currentAnomaly = alert.data;
            
            document.getElementById('modalTime').textContent = alert.time.toLocaleString();
            document.getElementById('modalIcon').textContent = alert.data.icon;
            document.getElementById('modalMetric').textContent = alert.data.metric;
            document.getElementById('modalValue').textContent = alert.data.value + alert.data.unit;
            document.getElementById('modalThreshold').textContent = `(Threshold: ${alert.data.threshold})`;
            document.getElementById('aiExplanation').textContent = 'Click "Explain with AI" to generate an analysis.';
            
            document.getElementById('anomalyModal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('anomalyModal').classList.remove('active');
        };



        window.generateAI = function() {
            if (!currentAnomaly) return;
            
            const explanations = {
                'Temperature': `The temperature reading of ${currentAnomaly.value}${currentAnomaly.unit} exceeds the threshold of ${currentAnomaly.threshold}, indicating a significant environmental anomaly. This could be caused by localized heat sources, seasonal weather patterns, or sensor calibration issues. Immediate investigation is recommended to determine if this represents a genuine environmental change requiring intervention.`,
                'Humidity': `The humidity level of ${currentAnomaly.value}${currentAnomaly.unit} is outside the normal range (threshold: ${currentAnomaly.threshold}). High humidity can promote mold growth and affect air quality, while low humidity can cause discomfort and health issues. Check ventilation systems and environmental controls.`,
                'Air Quality': `Poor air quality detected with ${currentAnomaly.value}${currentAnomaly.unit}, exceeding the safe threshold of ${currentAnomaly.threshold}. This suggests increased pollutant concentrations. Potential sources include industrial activities, vehicular emissions, or inadequate ventilation. Immediate action should be taken to identify and mitigate pollution sources.`
            };
            
            const explanation = explanations[currentAnomaly.metric] || 'Analysis unavailable.';
            document.getElementById('aiExplanation').textContent = explanation;
        };

        // Data timeout tracking
        let lastDataTimestamp = null;
        let dataTimeoutChecker = null;
        const DATA_TIMEOUT_MS = 60000; // 60 seconds - if no new data, show "No Data"
        const MAX_DATA_AGE_MS = 300000; // 5 minutes - ignore data older than this
        
        // DEBUG MODE: Set to true to show data regardless of age
        const DEBUG_IGNORE_TIMESTAMP = true; // ENABLED: Shows old data for testing

        function clearDashboard() {
            console.log('‚ö†Ô∏è No data received - clearing dashboard');
            
            // Update connection status
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            if (statusDot) {
                statusDot.style.background = '#ef4444';
                statusDot.style.animation = 'none';
            }
            if (statusText) {
                statusText.textContent = 'Disconnected';
                statusText.style.color = '#ef4444';
            }
            
            // Clear metric values
            document.getElementById('tempValue').textContent = '--';
            document.getElementById('humidityValue').textContent = '--';
            document.getElementById('airValue').textContent = '--';
            
            // Set all statuses to disconnected
            const statusElements = ['tempStatus', 'humidityStatus', 'airStatus'];
            statusElements.forEach(id => {
                const el = document.getElementById(id);
                el.className = 'metric-status';
                el.innerHTML = '<span style="color: #94a3b8;">‚ö†Ô∏è No Data</span>';
            });
            
            // Remove heartbeat animations
            document.querySelectorAll('.metric-card').forEach(card => {
                card.classList.remove('warning', 'critical', 'good');
            });
            
            // Stop all alert sounds
            if (typeof stopAllBackgroundAlertSounds === 'function') {
                stopAllBackgroundAlertSounds();
            }
            if (typeof stopAllHeartbeatSounds === 'function') {
                stopAllHeartbeatSounds();
            }
            
            // Update info panel
            document.getElementById('dataPoints').textContent = '--';
            document.getElementById('avgTemp').textContent = '--';
            document.getElementById('avgHumidity').textContent = '--';
            document.getElementById('updateTime').textContent = '‚ö†Ô∏è No data received';
        }

        function checkDataTimeout() {
            if (!lastDataTimestamp) return;
            
            const now = Date.now();
            const timeSinceLastData = now - lastDataTimestamp;
            
            if (timeSinceLastData > DATA_TIMEOUT_MS) {
                clearDashboard();
            }
        }

        function updateDashboard(data) {
            const entries = Object.values(data);
            allDataHistory = entries; // Store for export and predictions
            const latest = entries[entries.length - 1];
            const recent = entries.slice(-50);

            // Check if data is recent
            console.log('üïê Checking data timestamp...');
            console.log('   Latest entry timestamp:', latest.timestamp);
            
            const latestTimestamp = new Date(latest.timestamp).getTime();
            const now = Date.now();
            const dataAge = now - latestTimestamp;
            
            console.log('   Parsed timestamp:', new Date(latestTimestamp).toISOString());
            console.log('   Current time:', new Date(now).toISOString());
            console.log('   Data age:', Math.round(dataAge/1000), 'seconds');
            
            // Update last data timestamp
            lastDataTimestamp = now;
            
            // If data is extremely old (more than 5 minutes), ignore it and wait for fresh data
            if (dataAge > MAX_DATA_AGE_MS && !DEBUG_IGNORE_TIMESTAMP) {
                console.log(`‚ö†Ô∏è Data is ${Math.round(dataAge/1000)}s old (${Math.round(dataAge/60000)} minutes)`);
                console.log('‚è≥ Waiting for fresh data from ESP32...');
                console.log('üí° ESP32 should send new data every 10 seconds');
                console.log('üí° Or delete old data from Firebase Console');
                console.log('üí° Or set DEBUG_IGNORE_TIMESTAMP = true in code to bypass');
                clearDashboard();
                return;
            }
            
            if (DEBUG_IGNORE_TIMESTAMP && dataAge > MAX_DATA_AGE_MS) {
                console.log('üêõ DEBUG MODE: Showing old data (timestamp check bypassed)');
            }
            
            // If data age is negative (future timestamp), there's a clock sync issue
            if (dataAge < 0) {
                console.log('‚ö†Ô∏è WARNING: Data timestamp is in the future!');
                console.log('   This means ESP32 clock is ahead of your computer');
                console.log('   Accepting data anyway...');
            }
            
            console.log(`‚úÖ Data age: ${Math.round(dataAge/1000)}s (acceptable)`);

            // Update connection status to connected
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            if (statusDot) {
                statusDot.style.background = '#10b981';
                statusDot.style.animation = 'pulse 2s infinite';
            }
            if (statusText) {
                statusText.textContent = 'Connected';
                statusText.style.color = '#065f46';
            }

            updateMetrics(latest);

            // Update info panel
            document.getElementById('dataPoints').textContent = entries.length;
            const avgTemp = (recent.reduce((sum, e) => sum + e.temperature, 0) / recent.length).toFixed(1);
            const avgHumidity = (recent.reduce((sum, e) => sum + e.humidity, 0) / recent.length).toFixed(1);
            document.getElementById('avgTemp').textContent = avgTemp + '¬∞C';
            document.getElementById('avgHumidity').textContent = avgHumidity + '%';
            
            // Show data age if more than 10 seconds old
            const updateTimeEl = document.getElementById('updateTime');
            if (dataAge > 10000) {
                const secondsAgo = Math.round(dataAge / 1000);
                updateTimeEl.textContent = `‚ö†Ô∏è Updated ${secondsAgo}s ago`;
                updateTimeEl.style.color = '#f59e0b';
            } else {
                updateTimeEl.textContent = 'Updated ' + new Date(latest.timestamp).toLocaleTimeString();
                updateTimeEl.style.color = '';
            }

            // Update chart
            const labels = recent.map(e => new Date(e.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}));
            createChart({
                temp: recent.map(e => e.temperature),
                humidity: recent.map(e => e.humidity),
                air: recent.map(e => e.air_quality)
            }, labels);
        }

        // Listen for updates
        console.log('üî• Firebase initialized');
        console.log('üìç Database URL:', firebaseConfig.databaseURL);
        console.log('üìä Listening to: sensor_data');
        
        const sensorRef = ref(database, 'sensor_data');
        const recentQuery = query(sensorRef, limitToLast(50));

        onValue(recentQuery, (snapshot) => {
            console.log('üì° Firebase data received');
            const data = snapshot.val();
            console.log('üì¶ Data:', data);
            
            if (data) {
                console.log('‚úÖ Data exists, updating dashboard');
                console.log('üìà Number of entries:', Object.keys(data).length);
                updateDashboard(data);
            } else {
                console.log('‚ùå No data in Firebase');
                console.log('üí° Check:');
                console.log('   1. Firebase database exists');
                console.log('   2. Data is being written to sensor_data path');
                console.log('   3. Firebase rules allow read access');
                // No data in Firebase at all
                clearDashboard();
            }
        }, (error) => {
            console.error('üî• Firebase error:', error);
            console.error('üí° Possible issues:');
            console.error('   1. Wrong database URL');
            console.error('   2. Firebase rules deny read access');
            console.error('   3. Network/CORS issue');
        });

        // Start periodic timeout checker (every 5 seconds)
        dataTimeoutChecker = setInterval(checkDataTimeout, 5000);
        
        // Initial state
        clearDashboard();

        // Close modal on overlay click
        document.getElementById('anomalyModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Close logout modal on overlay click
        document.getElementById('logoutModal').addEventListener('click', function(e) {
            if (e.target === this) closeLogoutModal();
        });

        // Close modals with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeLogoutModal();
            }
        });

        // ========== PWA INTEGRATION ==========
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('‚úì Service Worker registered successfully');
                        console.log('‚úì PWA is ready - you can install this app!');
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showToast('üîÑ New version available! Refresh to update.', 'info');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('‚úó Service Worker registration failed:', error);
                    });
            });
        }

        // Request Notification Permission
        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('‚úì Notifications enabled');
                    showToast('‚úì Notifications enabled!', 'success');
                    
                    // Show test notification
                    if (navigator.serviceWorker.controller) {
                        new Notification('EnviTrack', {
                            body: 'You will now receive environmental alerts',
                            icon: '../images/logo.png',
                            badge: '../images/logo.png'
                        });
                    }
                } else if (permission === 'denied') {
                    console.log('‚úó Notifications blocked by user');
                }
            }
        }

        // Request notifications after 5 seconds
        setTimeout(requestNotificationPermission, 5000);

        // Show install prompt
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show custom install button
            showInstallPrompt();
        });

        function showInstallPrompt() {
            const installBanner = document.createElement('div');
            installBanner.className = 'install-banner';
            installBanner.innerHTML = `
                <div class="install-content">
                    <img src="../images/logo.png" alt="EnviTrack" class="install-icon-img">
                    <div class="install-text">
                        <div class="install-title">Install EcoMonitor</div>
                        <div class="install-desc">Get the app for faster access and offline support</div>
                    </div>
                </div>
                <div class="install-actions">
                    <button onclick="dismissInstall()" class="btn-dismiss">Later</button>
                    <button onclick="installPWA()" class="btn-install">Install</button>
                </div>
            `;
            document.body.appendChild(installBanner);
            
            setTimeout(() => installBanner.classList.add('show'), 100);
        }

        window.installPWA = async function() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('‚úì PWA installed');
                showToast('‚úì App installed successfully!', 'success');
            }
            
            deferredPrompt = null;
            dismissInstall();
        };

        window.dismissInstall = function() {
            const banner = document.querySelector('.install-banner');
            if (banner) {
                banner.classList.remove('show');
                setTimeout(() => banner.remove(), 300);
            }
        };

        window.addEventListener('appinstalled', () => {
            console.log('‚úì PWA was installed');
            showToast('‚úì EnviTrack installed! Open from your home screen.', 'success');
        });

        // Detect if running as PWA
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('‚úì Running as installed PWA');
        }
    </script>

    <!-- Enhanced Features Script -->
    <script src="features.js?v=7.0"></script>
</body>
</html>
